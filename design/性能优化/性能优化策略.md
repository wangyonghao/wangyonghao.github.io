# 数据库调优策略

### 代码

之所以把代码放到第一位，是因为这一点最容易引起技术人员的忽视。很多技术人员拿到一个性能优化的需求以后，言必称缓存、异步、JVM等。实际上，第一步就应该是分析相关的代码，找出相应的瓶颈，再来考虑具体的优化策略。有一些性能问题，完全是由于代码写的不合理，通过直接修改一下代码就能解决问题的，比如**for循环次数过多、作了很多无谓的条件判断、相同逻辑重复多次**等。

### 数据库

随着系统规模的不断增加，数据量和并发量不断增大，整个系统架构中最先受到冲击而形成瓶颈的数据库的调优，总的来说分为以下三部分：

#### SQL调优

这是**最常用、每一个技术人员都应该掌握基本的SQL调优手段（包括方法、工具、辅助系统等）**。这里以MySQL为例，最常见的方式是，由**自带的慢查询日志或者开源的慢查询系统**定位到具体的出问题的SQL，然后使用**explain、profile**等工具来逐步调优，最后经过测试达到效果后上线。

#### 连接池调优

我们的应用为了实现数据库连接的高效获取、对数据库连接的限流等目的，通常会采用连接池类的方案，即每一个应用节点都管理了一个到各个数据库的连接池。随着业务访问量或者数据量的增长，原有的连接池参数可能不能很好地满足需求，这个时候就需要结合**当前使用连接池的原理、具体的连接池监控数据和当前的业务量**作一个综合的判断，通过反复的几次调试得到最终的调优参数。

#### 架构层面调优

这一类调优包括**读写分离、多从库负载均衡、水平和垂直分库分表**等方面，一般需要的改动较大，但是频率没有SQL调优高，而且一般需要DBA来配合参与。那么什么时候需要做这些事情？我们可以通过内部监控报警系统（比如Zabbix），定期跟踪一些指标数据是否达到瓶颈，一旦达到瓶颈或者警戒值，就需要考虑这些事情。通常，DBA也会定期监控这些指标值。

### 缓存

缓存可分为两类：**本地缓存**（HashMap/ConcurrentHashMap、Ehcache、Guava Cache等），**缓存服务**（Redis/Tair/Memcache等）。

**什么情况适合用缓存？**考虑以下两种场景：

- 短时间内相同数据重复查询多次且数据更新不频繁，这个时候可以选择先从缓存查询，查询不到再从数据库加载并回设到缓存的方式。此种场景较适合用单机缓存。 
- 高并发查询热点数据，后端数据库不堪重负，可以用缓存来扛。

**选型考虑**：

- 如果数据量小，并且不会频繁地增长又清空（这会导致频繁地垃圾回收），那么可以选择本地缓存。具体的话，如果需要一些策略的支持（比如缓存满的逐出策略），可以考虑Ehcache；如不需要，可以考虑HashMap；如有多线程并发的场景，可以考虑ConcurentHashMap。
- 其他情况，可以考虑缓存服务。

**缓存设计关键点**：

- 什么时候更新缓存？

  1. 接收变更消息，准实时更新缓存。
  2. 给缓存设置过期时间，过期后从DB加载再回设到缓存中。

  第二个策略是对第一个策略的有力补充，解决了手动变更DB时不发消息导致的第一个策略失效的问题。

- 缓存满了怎么办？

  1. 给缓存服务选择合适的缓存逐出算法，比如最常见的LRU。 
  2. 针对当前设置的容量，设置适当的警戒值，比如10G的缓存，当缓存数据达到8G的时候，就开始发出报警，提前排查问题或者扩容。 
  3. 给缓存设置适当的过期时间。

- 缓存是否允许丢失？

  根据业务场景判断，是否允许丢失。如果不允许，就需要带持久化功能的缓存服务来支持，比如Redis或者Tair。更细节的话，可以根据业务对丢失时间的容忍度，还可以选择更具体的持久化策略，比如Redis的RDB或者AOF。

- 缓存被”击穿“问题

  **概念**：缓存在某个时间点过期的时候，恰好在这个时间点对这个Key有大量的并发请求过来，这些请求发现缓存过期一般都会从后端DB加载数据并回设到缓存，这个时候大并发的请求可能会瞬间把后端DB压垮。

  **如果解决**：业界比较常用的做法，是使用mutex。简单地来说，就是在缓存失效的时候（判断拿出来的值为空），不是立即去load db，而是先使用缓存工具的某些带成功操作返回值的操作（比如Redis的SETNX或者Memcache的ADD）去set一个mutex key，当操作返回成功时，再进行load db的操作并回设缓存；否则，就重试整个get缓存的方法。

### 异步

**使用场景**：

针对某些客户端的请求，在服务端可能需要针对这些请求做一些附属的事情，这些事情其实用户并不关心或者用户不需要立即拿到这些事情的处理结果，这种情况就比较适合用异步的方式处理这些事情。

**作用**:

- 缩短接口响应时间，使用户的请求快速返回，用户体验更好。
- 避免线程长时间处于运行状态，这样会引起服务线程池的可用线程长时间不够用，进而引起线程池任务队列长度增大，从而阻塞更多请求任务，使得更多请求得不到技术处理。
- 线程长时间处于运行状态，可能还会引起系统Load、CPU使用率、机器整体性能下降等一系列问题，甚至引发雪崩。异步的思路可以在不增加机器数和CPU数的情况下，有效解决这个问题。

**常见做法**：

一种做法**，是额外开辟线程，这里可以采用额外开辟一个线程或者使用线程池的做法，在IO线程（处理请求响应）之外的线程来处理相应的任务，在IO线程中让response先返回。

如果异步线程处理的任务设计的数据量非常巨大，那么可以引入阻塞队列BlockingQueue作进一步的优化。具体做法是让一批异步线程不断地往阻塞队列里扔数据，然后额外起一个处理线程，循环批量从队列里拿预设大小的一批数据，来进行批处理（比如发一个批量的远程服务请求），这样进一步提高了性能。

**另一种做法**，是使用消息队列（MQ）中间件服务，MQ天生就是异步的。一些额外的任务，可能不需要我这个系统来处理，但是需要其他系统来处理。这个时候可以先把它封装成一个消息，扔到消息队列里面，通过消息中间件的可靠性保证把消息投递到关心它的系统，然后让这个系统来做相应的处理。

比如C端在完成一个提单动作以后，可能需要其它端做一系列的事情，但是这些事情的结果不会立刻对C端用户产生影响，那么就可以先把C端下单的请求响应先返回给用户，返回之前往MQ中发一个消息即可。而且这些事情理应不是C端的负责范围，所以这个时候用MQ的方式，来解决这个问题最合适。

### JVM



### 

### 硬件

业务优化，索引优化，读写分离，升级网络，升级硬件，数据库切分（Sharding)



#### 索引优化

索引优化

### 



#### 服务器

1. 调整服务器内存分配

   内存分配是在信息系统运行过程中优化配置的，数据库管理员可以根据数据库运行状况调整数据库系统全局区（SGA区）的数据缓冲区、日志缓冲区和共享池的大小；还可以调整程序全局区（PGA区）的大小。需要注意的是，SGA区不是越大越好，SGA区过大会占用操作系统使用的内存而引起虚拟内存的页面交换，这样反而会降低系统。

2. 调整硬盘I/O

   数据库管理员可以将组成同一个表空间的数据文件放在不同的硬盘上，做到硬盘之间I/O负载均衡。

   日志

3. 调整操作系统参数

   例如：运行在[UNIX操作系统](https://www.baidu.com/s?wd=UNIX%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F&tn=SE_PcZhidaonwhc_ngpagmjz&rsv_dl=gh_pc_zhidao)上的ORACLE数据库，可以调整UNIX数据缓冲池的大小，每个进程所能使用的内存大小等参数。

#### 数据库

分库

分区

分表

#### 表结构

E-R模式 三大范式

字段类型、长度

#### 查询优化



### 优化工具

常用的数据库性能优化工具有： 

1、ORACLE数据库在线数据字典，ORACLE在线数据字典能够反映出ORACLE动态运行情况，对于调整数据库性能是很有帮助的。

2、操作系统工具，例如UNIX操作系统的vmstat，iostat等命令可以查看到系统系统级内存和硬盘I/O的使用情况，这些工具对于管理员弄清出系统瓶颈出现在什么地方有时候很有用。

3、SQL语言跟踪工具（SQL TRACE FACILITY），SQL语言跟踪工具可以记录SQL语句的执行情况，管理员可以使用虚拟表来调整实例，使用SQL语句跟踪文件调整应用程序性能。SQL语言跟踪工具将结果输出成一个操作系统的文件，管理员可以使用TKPROF工具查看这些文件。

4、ORACLE Enterprise Manager（OEM），这是一个图形的用户管理界面，用户可以使用它方便地进行数据库管理而不必记住复杂的ORACLE数据库管理的命令。



参考：

​	[常见性能优化策略的总结](https://tech.meituan.com/2016/12/02/performance-tunning.html)