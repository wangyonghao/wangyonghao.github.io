###### 多索引多类型

通过在URL中指定特殊的索引和类型达到这种效果，如下所示：

**/_search**

在所有的索引中搜索所有的类型

**/gb/_search**

在 gb 索引中搜索所有的类型

**/gb,us/_search**

在 gb 和 us 索引中搜索所有的文档

**/u\*/_search**

在任何以 g 或者 u 开头的索引中搜索所有的类型

**/gb/user/_search**

在 gb 索引中搜索 user 类型

**/gb,us/user,tweet/_search**

在 gb 和 us 索引中搜索 user 和 tweet 类型

**/_all/user,tweet/_search**

在所有的索引中搜索 user 和 tweet 类型



当在单一的索引下进行搜索的时候，Elasticsearch 转发请求到索引的每个分片中，可以是主分片也可以是副本分片，然后从每个分片中收集结果。多索引搜索恰好也是用相同的方式工作的—只是会涉及到更多的分片。





一个**副本分片**只是一个主分片的拷贝。副本分片作为硬件故障时保护数据不丢失的冗余备份，并为搜索和返回文档等读操作提供服务。



`PUT /{index}/{type}/{id}` 一次只能创建一个索引

 `/g*,u*/_search` 可以同时搜索多索引



###### 扩容

索引内任意一个文档都归属于一个**主分片**，所以主分片的数目决定着索引能够保存的最大数据量。

在索引建立的时候就已经确定了主分片数，但是副本分片数可以随时修改。

这个配置在索引创建后不能修改。

```shell
PUT /blogs
{
   "settings" : {
      "number_of_shards" : 3,
      "number_of_replicas" : 1
   }
}
```

**number_of_shards**

每个索引的主分片数，默认值是 5 。这个配置在索引创建后不能修改。

**number_of_replicas**

每个主分片的副本数，默认值是 1 。对于活动的索引库，这个配置可以随时修改。

调整副本分片数

```shell
PUT /blogs/_settings
{
   "number_of_replicas" : 2
}
```

![img](/assets/1680833512574-f54ef2d5-f629-43ef-9695-79da5527358c.png)



###### 导出索引Mapping

```
GET /invoice_list/_mapping
```

###### 更新索引Mapping

```shell
PUT /invoice_list
{
    "mappings": {
        "my_type": {
            "date_detection": false
        }
    }
}
```

###### 更新字段类型，需要重建索引

```
GET /invoice_list/_search?scroll=1m
```







### 集群分片设置

ES 一旦创建好索引后，就无法调整分片的设置，而在 ES 中，一个分片实际上对应一个 lucene 索引，而 lucene 索引的读写会占用很多的系统资源，因此，分片数不能设置过大；所以，在创建索引时，合理配置分片数是非常重要的。一般来说，我们遵循一些原则：

控制每个分片占用的硬盘容量不超过 ES 的最大 JVM 的堆空间设置（一般设置不超过 32 G，参考上面的 JVM 内存设置原则），因此，如果索引的总容量在 500 G 左右，那分片大小在 16 个左右即可；当然，最好同时考虑原则 2。 考虑一下 node 数量，一般一个节点有时候就是一台物理机，如果分片数过多，大大超过了节点数，很可能会导致一个节点上存在多个分片，一旦该节点故障，即使保持了 1 个以上的副本，同样有可能会导致数据丢失，集群无法恢复。所以，一般都设置分片数不超过节点数的 3 倍。